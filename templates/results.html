{% extends "base.html" %}
{% block content %}
<main class="max-w-6xl mx-auto p-4">
  <h1 class="text-2xl font-bold mb-4">Voting Results</h1>

  <div id="leaderboard">
    {% if top %}
      <div id="top-cottage" class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 mb-6" role="alert">
        üèÜ Leading Cottage: <strong>{{ top }}</strong> ({{ top_votes }} vote{{ 's' if top_votes != 1 else '' }})
      </div>
    {% endif %}
  </div>

  <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
    {% for c in cottages %}
    <div class="bg-white p-4 rounded shadow cottage-card" data-id="{{ c['id'] }}">
      <img src="{{ c['image'] }}" alt="{{ c['name'] }}" class="w-full h-48 object-cover rounded mb-2">
<h4 class="text-2xl font-bold mb-4">
  <a href="{{ c['url'] }}" target="_blank" class="text-blue-600 hover:text-blue-800 underline">
    {{ c['name'] }} - open cottage website
  </a></h4>
      <p class="text-gray-500">
        Votes: <span class="vote-count" id="votes-{{ c['id'] }}">{{ c['votes'] }}</span>
      </p>

      <button class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded vote-btn mt-2"
              data-id="{{ c['id'] }}">
        Vote
      </button>
      <div class="vote-msg mt-2 text-yellow-700"></div>

      {% if c.voters %}
      <div class="mt-3 bg-gray-50 p-2 rounded border border-gray-200">
        <h3 class="font-medium text-gray-700 mb-1">Voters:</h3>
        <ul class="text-gray-600 text-sm">
          {% for v in c.voters %}
          <li id="vote-{{ v['id'] }}">
            <span class="vote-user">{{ v['user_name'] }}</span> - <span class="vote-time">{{ v['voted_at'] }}</span>
            <form action="{{ url_for('delete_vote', vote_id=v['id']) }}" method="post" style="display:inline">
              <button type="submit" class="text-sm text-red-600 ml-2">Delete</button>
            </form>
          </li>
          {% endfor %}
        </ul>
      </div>
      {% else %}
        <p class="text-gray-400 mt-2">No votes yet</p>
      {% endif %}
    </div>
    {% endfor %}
  </div>
</main>

<script>
async function updateLeaderboard() {
  try {
    const res = await fetch("/results_data");
    const data = await res.json();
    const topDiv = document.getElementById("top-cottage");
    if (data.top) {
      topDiv.innerHTML = `üèÜ Leading Cottage: <strong>${data.top}</strong> (${data.top_votes} vote${data.top_votes !== 1 ? 's' : ''})`;
    }
    // Update all vote counts
    data.cottages.forEach(c => {
      const voteSpan = document.getElementById(`votes-${c.id}`);
      if (voteSpan) voteSpan.textContent = c.votes;
    });
  } catch(err) {
    console.error("Failed to update leaderboard:", err);
  }
}

document.querySelectorAll('.vote-btn').forEach(button => {
  button.addEventListener('click', async () => {
    const cottageId = button.dataset.id;
    const voteSpan = document.getElementById(`votes-${cottageId}`);
    const msgDiv = button.nextElementSibling;

    try {
      const response = await fetch(`/vote/${cottageId}`, { method: 'POST' });
      const data = await response.json();

      if (response.ok) {
        voteSpan.textContent = data.vote;
        msgDiv.textContent = "Vote registered!";
        // Update leaderboard after voting
        updateLeaderboard();
        setTimeout(() => msgDiv.textContent = "", 2000);
      } else {
        msgDiv.textContent = data.status || "You already voted!";
        setTimeout(() => msgDiv.textContent = "", 2000);
      }
    } catch (err) {
      msgDiv.textContent = "Error! Try again.";
      setTimeout(() => msgDiv.textContent = "", 2000);
    }
  });
});

// Edit vote inline handlers
// (vote edit UI removed)
</script>
{% endblock %}



