{% extends "base.html" %}
{% block content %}
<main class="max-w-3xl mx-auto p-4">
  <div class="bg-white p-6 rounded-lg shadow">
    <img src="{{ c['image'] }}" alt="{{ c['name'] }}" class="w-full h-64 object-cover rounded-md mb-4">

</p>
      <div class="flex justify-between items-start mb-4">
        <div>
          {% if c['url'] %}
            <h2 class="text-2xl font-bold">
              <a href="{{ c['url'] }}" target="_blank" class="text-blue-600 hover:text-blue-800 underline" data-tooltip="Open the official website for this cottage in a new tab.">
                {{ c['name'] }} - open cottage website
              </a>
            </h2>
          {% else %}
            <h2 class="text-3xl font-bold">{{ c['name'] }}</h2>
          {% endif %}
        </div>
        <div class="flex items-center space-x-2">
          {% if session.get('user_name') and (session.get('user_name') == c['submitted_by'] or (allow_admin_override and session.get('user_name') in admin_users)) %}
          <a href="{{ url_for('edit_cottage', cottage_id=c['id']) }}" 
             class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded flex items-center" data-tooltip="Edit this cottage's details.">
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
            </svg>
            Edit
          </a>

          <!-- Delete button opens confirmation modal -->
          <button id="delete-btn" type="button" 
                  class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded flex items-center" data-tooltip="Delete this cottage. Only owners or admins can delete.">
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
            Delete
          </button>
          {% endif %}
        </div>
      </div>
    <p class="text-gray-600">{{ c['location'] }} - {{ c['price'] }}</p>
    
    <!-- Cottage Features -->
    <div class="mt-4 grid grid-cols-2 md:grid-cols-3 gap-4">
      <!-- Basic Info -->
      <div class="flex items-center">
        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>
        </svg>
        <span>{{ c['beds'] }} bed{{ 's' if c['beds'] != 1 else '' }}</span>
      </div>

      <!-- Dogs -->
      {% if c['dogs_allowed'] %}
      <div class="flex items-center text-green-600">
        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 10h4.764a2 2 0 011.789 2.894l-3.5 7A2 2 0 0115.263 21h-4.017c-.163 0-.326-.02-.485-.06L7 20m7-10V5a2 2 0 00-2-2h-.095c-.5 0-.905.405-.905.905a3.61 3.61 0 01-.608 2.006L7 11v9m7-10h-2M7 20H5a2 2 0 01-2-2v-6a2 2 0 012-2h2.5"></path>
        </svg>
        <span>Dogs Welcome</span>
      </div>
      {% endif %}

      <!-- Hot Tub -->
      {% if c['hottub'] %}
      <div class="flex items-center text-blue-600">
        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
        </svg>
        <span>Hot Tub</span>
      </div>
      {% endif %}

      <!-- Secure Garden -->
      {% if c['secure_garden'] %}
      <div class="flex items-center text-green-600">
        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path>
        </svg>
        <span>Secure Garden</span>
      </div>
      {% endif %}

      <!-- EV Charging -->
      {% if c['ev_charging'] %}
      <div class="flex items-center text-blue-600">
        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
        </svg>
        <span>EV Charging</span>
      </div>
      {% endif %}

      <!-- Parking -->
      {% if c['parking'] %}
      <div class="flex items-center">
        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18"></path>
        </svg>
        <span>Parking Available</span>
      </div>
      {% endif %}

      <!-- Log Burner -->
      {% if c['log_burner'] %}
      <div class="flex items-center text-orange-600">
        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 18.657A8 8 0 016.343 7.343S7 9 9 10c0-2 .5-5 2.986-7C14 5 16.09 5.777 17.656 7.343A7.975 7.975 0 0120 13a7.975 7.975 0 01-2.343 5.657z"></path>
        </svg>
        <span>Log Burner</span>
      </div>
      {% endif %}

      <!-- High Chair -->
      {% if c['high_chair'] %}
      <div class="flex items-center">
        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"></path>
        </svg>
        <span>High Chair</span>
      </div>
      {% endif %}

      <!-- Cot -->
      {% if c['cot'] %}
      <div class="flex items-center">
        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4M4 12a2 2 0 110-4h16a2 2 0 110 4H4zm0 0v6a2 2 0 002 2h12a2 2 0 002-2v-6"></path>
        </svg>
        <span>Cot Available</span>
      </div>
      {% endif %}
    </div>

    <div class="mt-4 prose max-w-none">{{ c['description']|safe }}</div>

    <!-- Delete confirmation modal -->
    <div id="delete-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
      <div class="bg-white p-6 rounded shadow max-w-md w-full">
        <h3 class="text-xl font-bold mb-2 text-red-600">Delete cottage?</h3>
        <p class="mb-4">This will permanently delete the cottage, its comments and votes. This action cannot be undone.</p>
        <div class="flex justify-end space-x-2">
          <button id="cancel-delete" class="bg-gray-200 px-4 py-2 rounded">Cancel</button>
          <form id="delete-form" action="{{ url_for('delete_cottage', cottage_id=c['id']) }}" method="post" style="display:inline">
            <button type="submit" class="bg-red-600 text-white px-4 py-2 rounded">Confirm Delete</button>
          </form>
        </div>
      </div>
    </div>

    <!-- Voting -->
    <div class="mt-4 flex items-center space-x-2">
      <div class="mt-2 flex items-center space-x-2">
    {% if session.get('user_name') %}
    <button 
      data-id="{{ c['id'] }}"
      class="vote-btn px-3 py-1 rounded text-white 
             {% if c['id'] in session.get('voted', []) %}
               bg-gray-400 cursor-not-allowed
             {% else %}
               bg-blue-500 hover:bg-blue-600
             {% endif %}"
      {% if c['id'] in session.get('voted', []) %}disabled{% endif %}
      data-tooltip="Vote for this cottage. You can only vote for one cottage."
    >
      {% if c['id'] in session.get('voted', []) %}
        Voted
      {% else %}
        Vote
      {% endif %}
    </button>
    {% else %}
    <button class="px-3 py-1 rounded bg-gray-300 text-white cursor-not-allowed" disabled title="Log in to vote">Login to vote</button>
    <a href="{{ url_for('join') }}" class="ml-2 text-blue-600 underline" data-tooltip="Join the voting group to vote.">Join</a>
    {% endif %}


  <span class="vote-count" id="votes-{{ c['id'] }}">{{ c['votes'] }} vote{{ 's' if c['votes'] != 1 else '' }}</span>
</div>
<div class="vote-msg mt-2 text-yellow-700"></div>

    </div>

    <!-- Comments -->
    <div class="mt-6">
      <h2 class="text-xl font-bold mb-2">Comments</h2>
      <form action="{{ url_for('cottage_detail', cottage_id=c['id']) }}" method="post" class="mb-4">
        <textarea name="comment" rows="3" class="w-full border rounded p-2 focus:outline-none focus:ring-2 focus:ring-blue-400" placeholder="Add a comment..." required></textarea>
        <button type="submit" class="mt-2 bg-green-500 hover:bg-green-600 text-white px-4 py-1 rounded" data-tooltip="Post your comment about this cottage.">Post Comment</button>
      </form>

      <div class="space-y-2">
        {% for cm in comments %}
        <div class="bg-gray-100 p-2 rounded" id="comment-{{ cm['id'] }}">
          <div class="flex justify-between items-start">
            <div>
              <span class="font-semibold">{{ cm['author'] }}</span>:
              <span class="comment-text" id="comment-text-{{ cm['id'] }}">{{ cm['text'] }}</span>
            </div>
            <div class="space-x-2">
              {% if session.get('user_name') and (session.get('user_name') == cm['author'] or (allow_admin_override and session.get('user_name') in admin_users)) %}
              <button type="button" class="edit-comment-btn text-sm text-blue-600" data-id="{{ cm['id'] }}" data-tooltip="Edit your comment.">Edit</button>
              <form action="{{ url_for('delete_comment', comment_id=cm['id']) }}" method="post" style="display:inline">
                <button type="submit" class="text-sm text-red-600" data-tooltip="Delete your comment.">Delete</button>
              </form>
              {% endif %}
            </div>
          </div>

          <form action="{{ url_for('edit_comment', comment_id=cm['id']) }}" method="post" class="edit-comment-form hidden mt-2" id="edit-form-{{ cm['id'] }}">
            <textarea name="text" rows="3" class="w-full border rounded p-2">{{ cm['text'] }}</textarea>
            <div class="mt-2 flex space-x-2">
              <button type="submit" class="bg-blue-500 text-white px-3 py-1 rounded" data-tooltip="Save your edited comment.">Save</button>
              <button type="button" class="cancel-edit-btn text-gray-600 px-3 py-1 rounded" data-id="{{ cm['id'] }}" data-tooltip="Cancel editing your comment.">Cancel</button>
            </div>
          </form>
        </div>
        {% else %}
        <p class="text-gray-500">No comments yet.</p>
        {% endfor %}
      </div>
    </div>
  </div>
</main>
<script>
document.querySelectorAll('.vote-btn').forEach(button => {
  button.addEventListener('click', async () => {
    const cottageId = button.dataset.id;
    const voteSpan = document.getElementById(`votes-${cottageId}`);
    const msgDiv = button.parentElement.querySelector('.vote-msg');
    const voteHistoryDiv = document.getElementById(`vote-history-${cottageId}`)?.querySelector('ul');

    try {
      const response = await fetch(`/vote/${cottageId}`, { method: 'POST' });
      const data = await response.json();

      if (response.ok) {
        // Update vote count
        voteSpan.textContent = data.votes;

        // Add the new voter to history
        if (voteHistoryDiv) {
          const li = document.createElement('li');
          li.textContent = data.user_name + ' at ' + data.voted_at;
          voteHistoryDiv.prepend(li); // newest first
        }

        // Disable the button after voting
        button.disabled = true;
        button.classList.add('bg-gray-400', 'cursor-not-allowed');
        button.classList.remove('bg-blue-500', 'hover:bg-blue-600');

        msgDiv.textContent = "Vote registered!";
        setTimeout(() => msgDiv.textContent = "", 2000);
      } else {
        if (data.status === 'already_voted_elsewhere') {
          showVoteConflict(msgDiv, data.cottage_id, data.vote_id, cottageId, button);
        } else {
          msgDiv.textContent = data.message || data.status || "You already voted!";
          setTimeout(() => msgDiv.textContent = "", 2000);
        }
      }
    } catch (err) {
      msgDiv.textContent = "Error! Try again.";
      setTimeout(() => msgDiv.textContent = "", 2000);
    }
  });
});

function showVoteConflict(container, existingCottageId, existingVoteId, originalCottageId, origButton) {
  container.innerHTML = '';
  const info = document.createElement('div');
  info.className = 'p-3 bg-yellow-100 rounded';
  info.innerHTML = `You already voted for <a href="/cottage/${existingCottageId}" class="text-blue-600 underline">that cottage</a>. `;

  const delBtn = document.createElement('button');
  delBtn.className = 'ml-2 px-3 py-1 bg-red-500 text-white rounded';
  delBtn.textContent = 'Delete my previous vote';

  delBtn.addEventListener('click', async () => {
    delBtn.disabled = true;
    try {
      const res = await fetch(`/vote/delete/${existingVoteId}`, { method: 'POST' });
      if (res.ok) {
        // retry original vote
        const retry = await fetch(`/vote/${originalCottageId}`, { method: 'POST' });
        const retryData = await retry.json();
        if (retry.ok) {
          const voteSpan = document.getElementById(`votes-${originalCottageId}`);
          if (voteSpan) voteSpan.textContent = retryData.votes;
          origButton.disabled = true;
          origButton.classList.add('bg-gray-400','cursor-not-allowed');
          origButton.classList.remove('bg-blue-500','hover:bg-blue-600');
          container.textContent = 'Switched vote successfully.';
          setTimeout(()=> container.textContent = '', 3000);
        } else {
          container.textContent = retryData.message || retryData.status || 'Vote failed after deleting previous vote.';
        }
      } else {
        const err = await res.json().catch(()=>({}));
        container.textContent = err.message || err.status || 'Failed to delete previous vote.';
      }
    } catch (e) {
      container.textContent = 'Error performing request.';
    }
  });

  info.appendChild(delBtn);
  container.appendChild(info);
}

// Delete modal handlers
const deleteModal = document.getElementById('delete-modal');
const deleteBtn = document.getElementById('delete-btn');
const cancelBtn = document.getElementById('cancel-delete');

if (deleteBtn) {
  deleteBtn.addEventListener('click', () => {
    deleteModal.classList.remove('hidden');
  });
}

if (cancelBtn) {
  cancelBtn.addEventListener('click', (e) => {
    e.preventDefault();
    deleteModal.classList.add('hidden');
  });
}

// Close modal on Escape
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape' && deleteModal && !deleteModal.classList.contains('hidden')) {
    deleteModal.classList.add('hidden');
  }
});

// Inline comment edit handlers
document.querySelectorAll('.edit-comment-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    const id = btn.dataset.id;
    const form = document.getElementById(`edit-form-${id}`);
    if (form) form.classList.remove('hidden');
    btn.style.display = 'none';
  });
});

document.querySelectorAll('.cancel-edit-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    const id = btn.dataset.id;
    const form = document.getElementById(`edit-form-${id}`);
    const editBtn = document.querySelector(`.edit-comment-btn[data-id='${id}']`);
    if (form) form.classList.add('hidden');
    if (editBtn) editBtn.style.display = '';
  });
});
</script>


{% endblock %}
