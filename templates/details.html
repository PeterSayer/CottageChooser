{% extends "base.html" %}
{% block content %}
<main class="max-w-3xl mx-auto p-4">
  <div class="bg-white p-6 rounded-lg shadow">
    <img src="{{ c['image'] }}" alt="{{ c['name'] }}" class="w-full h-64 object-cover rounded-md mb-4">
    <h2 class="text-3xl font-bold mb-4"><p>
  {% if c['url'] %}
<h2 class="text-3xl font-bold mb-4">
  <a href="{{ c['url'] }}" target="_blank" class="text-blue-600 hover:text-blue-800 underline">
    {{ c['name'] }} - open cottage website
  </a></h2>

{% else %}
<h2 class="text-3xl font-bold mb-4">{{ c['name'] }}</h2>
{% endif %}

</h2>
</p>

    <p class="text-gray-600">{{ c['location'] }} - {{ c['price'] }} / night</p>
    <p class="text-gray-500">{{ c['beds'] }} bed{{ 's' if c['beds'] != 1 else '' }}{% if c['dogs_allowed'] %}, dogs allowed{% endif %}</p>
    <p class="mt-2">{{ c['description'] }}</p>

    <!-- Voting -->
    <div class="mt-4 flex items-center space-x-2">
      <div class="mt-2 flex items-center space-x-2">
  <button 
  data-id="{{ c['id'] }}"
  class="vote-btn px-3 py-1 rounded text-white 
         {% if c['id'] in session.get('voted', []) %}
           bg-gray-400 cursor-not-allowed
         {% else %}
           bg-blue-500 hover:bg-blue-600
         {% endif %}"
  {% if c['id'] in session.get('voted', []) %}disabled{% endif %}
>
  {% if c['id'] in session.get('voted', []) %}
    Voted
  {% else %}
    Vote
  {% endif %}
</button>


  <span class="vote-count" id="votes-{{ c['id'] }}">{{ c['votes'] }} vote{{ 's' if c['votes'] != 1 else '' }}</span>
</div>
<div class="vote-msg mt-2 text-yellow-700"></div>

    </div>

    <!-- Comments -->
    <div class="mt-6">
      <h2 class="text-xl font-bold mb-2">Comments</h2>
      <form action="{{ url_for('cottage_detail', cottage_id=c['id']) }}" method="post" class="mb-4">
        <textarea name="comment" rows="3" class="w-full border rounded p-2 focus:outline-none focus:ring-2 focus:ring-blue-400" placeholder="Add a comment..." required></textarea>
        <button type="submit" class="mt-2 bg-green-500 hover:bg-green-600 text-white px-4 py-1 rounded">Post Comment</button>
      </form>

      <div class="space-y-2">
        {% for cm in comments %}
        <div class="bg-gray-100 p-2 rounded">
          <span class="font-semibold">{{ cm['author'] }}</span>:
          <span>{{ cm['text'] }}</span>
        </div>
        {% else %}
        <p class="text-gray-500">No comments yet.</p>
        {% endfor %}
      </div>
    </div>
  </div>
</main>
<script>
document.querySelectorAll('.vote-btn').forEach(button => {
  button.addEventListener('click', async () => {
    const cottageId = button.dataset.id;
    const voteSpan = document.getElementById(`votes-${cottageId}`);
    const msgDiv = button.parentElement.querySelector('.vote-msg');
    const voteHistoryDiv = document.getElementById(`vote-history-${cottageId}`)?.querySelector('ul');

    try {
      const response = await fetch(`/vote/${cottageId}`, { method: 'POST' });
      const data = await response.json();

      if (response.ok) {
        // Update vote count
        voteSpan.textContent = data.votes;

        // Add the new voter to history
        if (voteHistoryDiv) {
          const li = document.createElement('li');
          li.textContent = data.user_name + ' at ' + data.voted_at;
          voteHistoryDiv.prepend(li); // newest first
        }

        // Disable the button after voting
        button.disabled = true;
        button.classList.add('bg-gray-400', 'cursor-not-allowed');
        button.classList.remove('bg-blue-500', 'hover:bg-blue-600');

        msgDiv.textContent = "Vote registered!";
        setTimeout(() => msgDiv.textContent = "", 2000);
      } else {
        msgDiv.textContent = "You already voted!";
        setTimeout(() => msgDiv.textContent = "", 2000);
      }
    } catch (err) {
      msgDiv.textContent = "Error! Try again.";
      setTimeout(() => msgDiv.textContent = "", 2000);
    }
  });
});
</script>


{% endblock %}
