{% extends "base.html" %}
{% block content %}
<div class="max-w-5xl mx-auto px-4 py-8">
  <div class="flex items-center justify-between mb-6">
    <h1 class="text-3xl font-semibold text-gray-900">Cottage Chooser – Technical Support</h1>
    <a href="{{ url_for('cottages') }}" class="text-blue-600 hover:text-blue-700" data-tooltip="Back to the cottage list">
      &larr; Back
    </a>
  </div>

  <p class="text-gray-700 mb-6">
    This document helps operators and contributors set up, configure, deploy, and troubleshoot the Cottage Chooser application.
  </p>

  <div class="space-y-10">

    <section id="requirements">
      <h2 class="text-2xl font-semibold text-gray-900 mb-3">System Requirements</h2>
      <ul class="list-disc ml-6 text-gray-700 space-y-1">
        <li>Python 3.9–3.12</li>
        <li>pip and venv</li>
        <li>SQLite (bundled with Python)</li>
        <li>Windows, Linux, or macOS</li>
      </ul>
    </section>

    <section id="env-vars">
      <h2 class="text-2xl font-semibold text-gray-900 mb-3">Configuration (Environment Variables)</h2>
      <ul class="list-disc ml-6 text-gray-700 space-y-2">
        <li><span class="font-mono">CC_SECRET</span>: Flask secret key. Defaults to “dev-secret-key”. Set a strong value in production.</li>
        <li><span class="font-mono">CC_ALLOW_ADMIN_OVERRIDE</span>: Enable admin override for deletes/edits (true/false).</li>
        <li><span class="font-mono">CC_ADMIN_USERS</span>: Comma-separated admin usernames (used with override).</li>
        <li><span class="font-mono">CC_ADMINS</span>: Comma-separated admin usernames (used for vote admin controls).</li>
      </ul>
      <p class="text-sm text-gray-600 mt-2">Note: The app unifies admin checks using CC_ADMIN_USERS and CC_ADMINS. Either can grant admin rights.</p>
    </section>

    <section id="setup">
      <h2 class="text-2xl font-semibold text-gray-900 mb-3">Local Setup (Windows, PowerShell)</h2>
      <pre class="bg-gray-900 text-gray-100 p-4 rounded text-sm overflow-x-auto"><code>
cd C:\Users\Peter\Downloads\CottageChooser_Full
py -3 -m venv .venv
.\.venv\Scripts\Activate.ps1
python -m pip install --upgrade pip setuptools wheel
python -m pip install -r requirements.txt
python app.py
      </code></pre>
      <p class="text-sm text-gray-600 mt-2">If venv activation is blocked, run: Set-ExecutionPolicy -Scope CurrentUser RemoteSigned</p>
    </section>

    <section id="database">
      <h2 class="text-2xl font-semibold text-gray-900 mb-3">Database</h2>
      <ul class="list-disc ml-6 text-gray-700 space-y-2">
        <li>SQLite file: <span class="font-mono">data.db</span> (auto-created in the app folder).</li>
        <li>Initialize using <span class="font-mono">/init</span> (loads schema.sql).</li>
        <li>Key tables:
          <ul class="list-disc ml-6 space-y-1">
            <li><span class="font-mono">cottages</span>: name, location, price, beds, dogs_allowed, image, url, description, hottub, secure_garden, ev_charging, parking, log_burner, high_chair, cot, votes, submitted_by, ai_review_summary.</li>
            <li><span class="font-mono">votes</span>: id, cottage_id, user_name, voted_at (one active vote per user; denormalized count kept in cottages.votes).</li>
            <li><span class="font-mono">comments</span>: id, cottage_id, author, text, created_at.</li>
          </ul>
        </li>
      </ul>
    </section>

    <section id="features">
      <h2 class="text-2xl font-semibold text-gray-900 mb-3">Application Features</h2>
      <ul class="list-disc ml-6 text-gray-700 space-y-2">
        <li>Join/Login via group code (default: “saywards”).</li>
        <li>List, compare, and view cottage details (with comments and voter list).</li>
        <li>Vote once per user; delete vote from Results to change it.</li>
        <li>Admins: manage votes on Results (view/delete any vote), optional override for deleting cottages/comments.</li>
        <li>Manual “AI Review Summary” field retained; edit on the cottage edit page.</li>
        <li>Help Mode tooltips with a floating toggle; tooltips appear below elements.</li>
      </ul>
    </section>

    <section id="security">
      <h2 class="text-2xl font-semibold text-gray-900 mb-3">Security Notes</h2>
      <ul class="list-disc ml-6 text-gray-700 space-y-2">
        <li>Set a strong <span class="font-mono">CC_SECRET</span> in production to protect sessions.</li>
        <li>Descriptions are sanitized with Bleach. Allowed tags: {{ ALLOWED_TAGS|default([])|join(', ') }}.</li>
        <li>Change the group code from the default “saywards” if you need privacy.</li>
        <li>HTTPS recommended for deployments; ensure cookies are secure.</li>
      </ul>
    </section>

    <section id="deployment">
      <h2 class="text-2xl font-semibold text-gray-900 mb-3">Deployment (Linux + Apache mod_wsgi)</h2>
      <ol class="list-decimal ml-6 text-gray-700 space-y-2">
        <li>Create a venv under the project, install requirements.</li>
        <li>Expose WSGI entry (e.g., cottage.wsgi) and point Apache to it.</li>
        <li>Set env vars (CC_SECRET, CC_ADMINS, CC_ALLOW_ADMIN_OVERRIDE, CC_ADMIN_USERS).</li>
        <li>Restart Apache after changes.</li>
      </ol>
      <p class="text-sm text-gray-600 mt-2">Ensure the Apache user can read the project and venv.</p>
    </section>

    <section id="ops">
      <h2 class="text-2xl font-semibold text-gray-900 mb-3">Operations</h2>
      <ul class="list-disc ml-6 text-gray-700 space-y-2">
        <li>Backup: stop the app, copy <span class="font-mono">data.db</span> and <span class="font-mono">static/</span>, <span class="font-mono">templates/</span>.</li>
        <li>Restore: replace <span class="font-mono">data.db</span>, then restart the app.</li>
        <li>Slides: add images to <span class="font-mono">static/slides/</span>; optional <span class="font-mono">static/presentation.pptx</span>.</li>
      </ul>
    </section>

    <section id="troubleshooting">
      <h2 class="text-2xl font-semibold text-gray-900 mb-3">Troubleshooting</h2>
      <div class="space-y-4">
        <details class="bg-white shadow rounded p-4">
          <summary class="font-medium text-gray-900 cursor-pointer">ModuleNotFoundError: No module named 'flask'</summary>
          <ul class="list-disc ml-6 text-gray-700 mt-2">
            <li>Activate venv: <span class="font-mono">.\.venv\Scripts\Activate.ps1</span></li>
            <li>Install deps: <span class="font-mono">python -m pip install -r requirements.txt</span></li>
            <li>Verify interpreter: <span class="font-mono">python -c "import sys; print(sys.executable)"</span></li>
          </ul>
        </details>

        <details class="bg-white shadow rounded p-4">
          <summary class="font-medium text-gray-900 cursor-pointer">No pyvenv.cfg file</summary>
          <ul class="list-disc ml-6 text-gray-700 mt-2">
            <li>Delete broken venv: <span class="font-mono">Remove-Item -Recurse -Force .venv</span></li>
            <li>Recreate: <span class="font-mono">py -3 -m venv .venv</span> then activate and install.</li>
          </ul>
        </details>

        <details class="bg-white shadow rounded p-4">
          <summary class="font-medium text-gray-900 cursor-pointer">Admin can’t delete votes</summary>
          <ul class="list-disc ml-6 text-gray-700 mt-2">
            <li>Set <span class="font-mono">CC_ADMINS</span> or <span class="font-mono">CC_ADMIN_USERS</span> with your username (case-insensitive).</li>
            <li>Ensure you’re logged in with that exact username.</li>
            <li>Endpoint: <span class="font-mono">POST /vote/delete/&lt;id&gt;</span> returns JSON <span class="font-mono">{ok: true}</span> on success.</li>
          </ul>
        </details>

        <details class="bg-white shadow rounded p-4">
          <summary class="font-medium text-gray-900 cursor-pointer">Template errors with sqlite3.Row and .get()</summary>
          <p class="text-gray-700 mt-2">Convert rows to dicts in views (e.g., <span class="font-mono">cottages = [dict(r) for r in rows]</span>) or use bracket access in templates.</p>
        </details>

        <details class="bg-white shadow rounded p-4">
          <summary class="font-medium text-gray-900 cursor-pointer">Tooltips not visible</summary>
          <p class="text-gray-700 mt-2">Toggle Help mode using the floating “Help” button; bubbles appear below elements on hover.</p>
        </details>
      </div>
    </section>

    <section id="endpoints">
      <h2 class="text-2xl font-semibold text-gray-900 mb-3">Key Endpoints</h2>
      <ul class="list-disc ml-6 text-gray-700 space-y-1">
        <li><span class="font-mono">/join</span> — Login/Join via group code.</li>
        <li><span class="font-mono">/cottages</span> — List cottages.</li>
        <li><span class="font-mono">/cottage/&lt;id&gt;</span> — Details/comments/voters.</li>
        <li><span class="font-mono">/add</span> — Add cottage.</li>
        <li><span class="font-mono">/edit/&lt;id&gt;</span> — Edit cottage (includes manual AI summary field).</li>
        <li><span class="font-mono">/results</span> — Rankings, delete vote (user/admin).</li>
        <li><span class="font-mono">/compare</span> — Side-by-side compare.</li>
        <li><span class="font-mono">/presentation</span> — Slides viewer.</li>
        <li><span class="font-mono">/results_data</span> — JSON snapshot for dashboards.</li>
        <li><span class="font-mono">/init</span> — One-time DB initialization (loads schema.sql).</li>
      </ul>
    </section>

  </div>
</div>
{% endblock %}